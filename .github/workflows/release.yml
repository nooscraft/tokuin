name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare-models:
    name: Prepare Embedding Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install optimum[exporters] transformers huggingface-hub

      - name: Download tokenizer
        run: |
          set -euxo pipefail
          mkdir -p models/all-MiniLM-L6-v2
          
          echo "Downloading tokenizer from HuggingFace..."
          python3 << 'PYTHON'
          from huggingface_hub import hf_hub_download
          import os
          
          model_id = "sentence-transformers/all-MiniLM-L6-v2"
          cache_dir = "models/all-MiniLM-L6-v2"
          
          try:
              tokenizer_path = hf_hub_download(
                  repo_id=model_id,
                  filename="tokenizer.json",
                  cache_dir=cache_dir,
                  local_dir=cache_dir,
                  local_dir_use_symlinks=False
              )
              print(f"✓ Tokenizer downloaded to {tokenizer_path}")
          except Exception as e:
              print(f"Error downloading tokenizer: {e}")
              # Fallback: try direct download
              import urllib.request
              url = f"https://huggingface.co/{model_id}/resolve/main/tokenizer.json"
              dest = os.path.join(cache_dir, "tokenizer.json")
              urllib.request.urlretrieve(url, dest)
              print(f"✓ Tokenizer downloaded via direct HTTP")
          PYTHON

      - name: Convert ONNX model
        run: |
          set -euxo pipefail
          echo "Converting model to ONNX format..."
          optimum-cli export onnx --model sentence-transformers/all-MiniLM-L6-v2 models/all-MiniLM-L6-v2/ || {
            echo "⚠️  ONNX conversion failed or model already exists. Continuing..."
          }
          
          if [ -f "models/all-MiniLM-L6-v2/model.onnx" ]; then
            echo "✓ ONNX model ready"
          else
            echo "⚠️  ONNX model not created (this is optional)"
          fi

      - name: Upload models artifact
        uses: actions/upload-artifact@v4
        with:
          name: embedding-models
          path: models/
          retention-days: 1

  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: prepare-models
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz
            use_cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            use_cross: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: ${{ matrix.use_cross }}
        run: cargo install cross --locked

      - name: Download models
        uses: actions/download-artifact@v4
        with:
          name: embedding-models
          path: models/

      - name: Cache ONNX Runtime binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ort.pyke.io
          key: ort-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ort-${{ matrix.target }}-

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          
          # Create cache directory with proper permissions
          # For cross, it will be mounted into the container
          mkdir -p "$HOME/.cache/ort.pyke.io"
          chmod -R 755 "$HOME/.cache/ort.pyke.io" || true
          
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            # Cross runs in Docker, so we need to ensure cache dir is accessible
            # The container will use /root/.cache by default
            cross build --locked --release --features all --target ${{ matrix.target }}
          else
            cargo build --locked --release --features all --target ${{ matrix.target }}
          fi

      - name: Package artifact
        shell: bash
        run: |
          set -euxo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          TARGET="${{ matrix.target }}"
          ARTIFACT_NAME="tokuin-${VERSION}-${TARGET}"
          BIN_DIR="target/${TARGET}/release"
          BIN_PATH="${BIN_DIR}/tokuin"
          if [ "${{ runner.os }}" = "Windows" ]; then
            BIN_PATH="${BIN_PATH}.exe"
          fi

          mkdir -p bundle
          cp "${BIN_PATH}" bundle/
          cp LICENSE-APACHE bundle/
          cp LICENSE-MIT bundle/
          cp README.md bundle/
          
          # Include models directory if it exists
          if [ -d "models" ]; then
            cp -r models bundle/
          fi

          mkdir -p dist
          if [ "${{ runner.os }}" = "Windows" ]; then
            pwsh -Command "Compress-Archive -Path 'bundle/*' -DestinationPath 'dist/${ARTIFACT_NAME}.zip'"
          else
            tar -C bundle -czf "dist/${ARTIFACT_NAME}.tar.gz" .
          fi

          rm -rf bundle

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist/
          if-no-files-found: error

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release artifacts
        run: |
          set -euxo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p upload

          find dist -maxdepth 2 -type f -name 'tokuin-*' -exec mv {} upload/ \;

          cd upload
          sha256sum tokuin-* > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Tokuin ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            upload/tokuin-*.tar.gz
            upload/tokuin-*.zip
            upload/checksums.txt
          generate_release_notes: true

